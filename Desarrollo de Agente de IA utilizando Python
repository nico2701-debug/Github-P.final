# -*- coding: latin-1 -*-
# Proyecto_Final_dashboard.py
# Autores: Giovanni, Nicole y Valeria
# Dashboard para análisis de %GC + Agente IA

import re
import pandas as pd
import matplotlib.pyplot as plt
import streamlit as st
from openai import OpenAI

st.title("Análisis de %GC de secuencias FASTA")


# ============================================================
# FUNCIÓN PARA CALCULAR GC
# ============================================================
def calcular_gc(seq):
    seq = seq.upper()
    gc_count = seq.count("G") + seq.count("C")
    total_bases = len(seq.replace("N", ""))  # se ignoran Ns
    return round((gc_count / total_bases) * 100, 2) if total_bases > 0 else 0


# ============================================================
# FUNCIÓN PARA LIMPIAR Y SIMPLIFICAR NOMBRE DE ORGANISMO
# ============================================================
def nombre_bacteria(encabezado, nombres_usados, max_words=4):
    nombre = encabezado.replace(">", "").strip()
    nombre = re.sub(r"[^A-Za-z\s]", "", nombre)
    palabras = nombre.split()[:max_words]
    nombre_corto = "_".join(palabras)
    contador = 1
    nombre_final = nombre_corto

    while nombre_final in nombres_usados:
        nombre_final = f"{nombre_corto}_{contador}"
        contador += 1

    nombres_usados.add(nombre_final)
    return nombre_final


# ============================================================
# SUBIDA MANUAL DE ARCHIVOS FASTA (ÚNICO MÉTODO)
# ============================================================
uploaded_files = st.file_uploader(
    "Sube tus archivos FASTA",
    type=["fasta", "fa"],
    accept_multiple_files=True
)

resultados = []
nombres_usados = set()


# ============================================================
# PROCESAMIENTO DE ARCHIVOS SUBIDOS
# ============================================================
if uploaded_files:
    for file in uploaded_files:
        lineas = file.read().decode("utf-8").splitlines()

        if not lineas:
            continue

        encabezado = lineas[0]
        secuencia = "".join(lineas[1:])

        gc = calcular_gc(secuencia)
        nombre_final = nombre_bacteria(encabezado, nombres_usados)

        resultados.append({"Organismo": nombre_final, "%GC": gc})


# ============================================================
# MOSTRAR RESULTADOS (TABLA + GRÁFICO)
# ============================================================
if resultados:

    df = pd.DataFrame(resultados)

    st.subheader("Tabla de resultados")
    st.dataframe(df)

    # Gráfico
    fig, ax = plt.subplots(figsize=(10, 6))
    ax.bar(df["Organismo"], df["%GC"])
    plt.xticks(rotation=45, ha="right")
    plt.ylabel("% de GC")
    plt.title("Comparación del contenido GC entre organismos")
    plt.tight_layout()
    st.pyplot(fig)

    # =================== AGENTE IA ===================
    st.header("Descripción automática de resultados (%GC)")

    api_key = st.text_input("Ingresa tu API Key de OpenAI:", type="password")

    if api_key:

        client = OpenAI(api_key=api_key)

        prompt = f"""
        Analiza los siguientes resultados de %GC de secuencias FASTA:

        {df.to_string(index=False)}

        Indica en un párrafo:
        - Cuál organismo tiene mayor %GC
        - Cuál organismo tiene menor %GC
        - Qué significan estas diferencias desde un punto de vista biológico/funcional
        - Haz dos versiones: una en español y otra en inglés
        """

        try:
            response = client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": "Eres un asistente experto en biología molecular."},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.3
            )

            descripcion = response.choices[0].message.content

            st.subheader("Descripción generada por IA:")
            st.write(descripcion)

        except Exception as e:
            st.error(f"Error al generar descripción: {e}")

else:
    st.info("Sube archivos FASTA para iniciar el análisis.")
